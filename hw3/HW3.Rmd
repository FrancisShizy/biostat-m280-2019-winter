---
title: "Biostat M280 Homework 3"
author: "Zanyu Shi UID: 805228169 <zyshi@g.ucla.edu>"
subtitle: Due Mar 1 @ 11:59PM
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

##Q1 LA City Employee Payroll
1. For efficiency of the Shiny app, you should first pre-process, pare down, tidy, and save the data, e.g., as a compressed RDS file, to be used in the app.

```{r}
library(tidyverse)
library(data.table)
#read the .csv file
LACEP <- fread("/home/m280data/la_payroll/City_Employee_Payroll.csv")
LACEP = as.data.frame(LACEP)
names(LACEP) <- str_remove_all(names(LACEP), "[\\&\\(\\)]")
names(LACEP) <- str_replace_all(names(LACEP), " ", "_")
names(LACEP) <- str_replace_all(names(LACEP), "__", "_")

```

#### Save The dataset as a RDS file.
```{r}
saveRDS(LACEP, 
      file = "/home/zyshi/biostat-m280-2019-winter/hw3/LACEP-app/LACEPdat.rds")
```

2. **Total payroll by LA City**. Visualize the total LA City payroll of each year, with breakdown into base pay, overtime pay, and other pay.

3. **Who earned most?** Visualize the payroll information (total payment with breakdown into base pay, overtime pay, and other pay, Department, Job Title) of the top $n$ highest paid LA City employees in a specific year. User specifies $n$ (default 10) and year (default 2017).

4. **Which departments earn most?** Visualize the mean or median payroll, with breakdown into base pay, overtime pay, and other pay, of top $n$ earning departments. User specifies $n$ (default 5), year (default 2017), and method (mean or median, default median).

5. **Which departments cost most?** Visualize the total payroll, with breakdown into base pay, overtime pay, and other pay, of top $n$ expensive departments. User specifies $n$ (default 5) and year (default 2017).

6. Visualize any other information you are interested in.

7. Publish your Shiny app to <https://www.shinyapps.io> and share the link.

### The link for my Shiny app:
My shiny app: <https://zyshi-shinyapps.shinyapps.io/lacep-app/>


## Q2 LA City Parking War

The SQLite database `/home/m280data/la_parking/LA_Parking_Citations.sqlite` on teaching server contains information about parking tickets in LA City. It was downloaded from [LA Open Data Portal](https://data.lacity.org/A-Well-Run-City/Parking-Citations/wjz9-h9np). Connect to the database and answer following questions using plots and summary statistics. In this exercise, you are **not** allowed to load whole data into memory. Use the _transform in database, plot in R_ strategy.

#### Read the SQLite database

```{r}
library("DBI")
library("RSQLite")
library("dplyr")
db <- dbConnect(RSQLite::SQLite(), 
        dbname = "/home/m280data/la_parking/LA_Parking_Citations.sqlite")
dbListTables(db)
```

```{r}
lap_sql <- dplyr::tbl(db, "latix")
str(lap_sql)
```

```{r}
lap_sql %>% print(width = Inf)
```


1. How many tickets are in this data set? Which time period do these tickets span? Which years have most data?

### Solution
The number of tickets in this dataset is 7656418. The time period that these tickets span is from 01:00 07/02/2015 to 23:58 01/25/2019. The year 2017 has the most data. 

```{r}
addr <- lap_sql %>%
  summarize(n = n()) %>% 
  show_query()
addr
```


```{r}
tsyear <- lap_sql %>%
  filter(!is.na(Issue_Year), !is.na(Issue_Month), 
         !is.na(Issue_Day), !is.na(Issue_Hour), 
         !is.na(Issue_Minute), !is.na(Issue_Wday)) 

tsyear %>% arrange(desc(Issue_Year), desc(Issue_Month), desc(Issue_Day), 
                 desc(Issue_Hour), desc(Issue_Minute)) %>%
  select(Issue_Year, Issue_Month, Issue_Day, Issue_Hour, Issue_Minute) %>%
  collect() %>%
  slice(c(1, n()))
```

```{r}
lap_sql %>%
 group_by(Issue_Year) %>%
 count() %>% 
 collect() %>%
 ggplot() + 
 geom_col(aes(x = Issue_Year, y = n)) 
```


2. When (which hour, weekday, month day, and month) are you most likely to get a ticket and when are you least likely to get a ticket?
### Solution
#### a) Hour: 
12 is the hour that you are most likely to get a ticket; 5 is the hour that you are least likely to get a ticket.
```{r}
thour <- lap_sql %>%
  group_by(Issue_Hour) %>%
  summarize(n = n()) %>% 
  arrange(desc(n))
 thour
```

#### b) Weekday: 
Wednesday is the weekday that you are most likely to get a ticket; Monday is the weekday that you are least likely to get a ticket.
```{r}
twday <- lap_sql %>%
  group_by(Issue_Wday) %>%
  summarize(n = n()) %>% 
  arrange(desc(n))
 twday
```

#### c) Month day: 
13th is the month day that you are most likely to get a ticket; 31st is the month day that you are least likely to get a ticket.
```{r}
tmday <- lap_sql %>%
  group_by(Issue_Day) %>%
  summarize(n = n()) %>% 
  arrange(desc(n))
 tmday
```

#### d) Month: 
August is the month that you are most likely to get a ticket; February is the month that you are least likely to get a ticket.
```{r}
tmonth <- lap_sql %>%
  group_by(Issue_Month) %>%
  summarize(n = n()) %>% 
  arrange(desc(n))
 tmonth
```

3. Which car makes received most citations?

**The car make TOYT received the most citations.**

```{r}
 carm <- lap_sql %>%
   group_by(Make) %>%
   summarize(n = n()) %>% 
   arrange(desc(n))
 carm
```

4. How many different colors of cars were ticketed? Which color attracted most tickets?

**There are 103 different colors of cars ticketed; BK atrracted the most tickets 1652621.**

```{r}
 colorc <- lap_sql %>%
   group_by(Color) %>%
   summarize(n = n()) %>% 
   arrange(desc(n))
colorc
```

5. What are the most common ticket types?

**"NO PARK/STREET CLEAN" is the most common ticket types.**

```{r}
typet <- lap_sql %>%
   group_by(Violation_Description) %>%
   summarize(n = n()) %>% 
   arrange(desc(n))
typet
```

6. How much money was collected on parking tickets in 2016, 2017 and 2018?

In 2016, 152145538 dollars are collected on parking tickets; in 2017, 157122489 dollars are collected on parking tickets; in 2018, 138875787 dollars are collected on parking tickets.
```{r}
mcpt <- lap_sql %>%
   group_by(Issue_Year) %>%
   summarize(moneyc = sum(Fine_amount)) 
mcpt
```

7. If you've been ticketed in LA County, did you find your ticket in this data set?

Opps, I don't have a car.

8. Read the blog <http://www.brettrics.com/9-million-parking-tickets-la/> and try to reproduce plots using your data.
